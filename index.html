<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ JERCAT Trading Bot - Wallet Auto-Mode R√âEL (USDT)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            backdrop-filter: blur(10px);
            border: 1px solid #334155;
        }
        .gradient-text {
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 1000% 1000%;
            animation: gradient 30s linear infinite;
            font-weight: 900;
        }
        @keyframes gradient {
            0% { background-position: 0% center; }
            100% { background-position: 1000% center; }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass-effect rounded-2xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-5xl font-black gradient-text mb-2" style="text-shadow: 0 4px 8px rgba(0,0,0,0.8), 0 0 40px rgba(245, 158, 11, 0.6), 0 0 80px rgba(245, 158, 11, 0.4); transform: translateZ(0); filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.5));">
                        ü§ñ JERCAT Auto-Trading R√âEL
                    </h1>
                    <p class="text-gray-400">
                        ‚ö° Connexion Auto JERCAT Wallet ‚Ä¢ üéØ Mode R√âEL Blockchain ‚Ä¢ üî• Zero-Click Trading
                    </p>
                    <p class="text-green-400 font-bold text-sm mt-2">
                        ‚úÖ AUTO-VALIDATION JERCAT - Transactions automatiques sans confirmation
                    </p>
                    <p class="text-yellow-400 font-bold text-sm mt-1">
                        üíµ TRADING EN USDT (au lieu de BNB)
                    </p>
                </div>
                
                <div class="flex gap-2 flex-wrap">
                    <button onclick="openJercatWallet()" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all shadow-lg" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);">
                        <span>ü§ñ</span>
                        <span>JERCAT Wallet</span>
                    </button>
                    <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 shadow-lg">
                        <span>üëõ</span>
                        <span id="walletText">MetaMask</span>
                    </button>
                    <button onclick="togglePrivateKeyModal()" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 shadow-lg">
                        <span>üîë</span>
                        <span>Cl√© Priv√©e</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Private Key Modal -->
        <div id="privateKeyModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-6 max-w-md w-full border-2 border-red-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-red-400">‚ö†Ô∏è Cl√© Priv√©e</h3>
                    <button onclick="togglePrivateKeyModal()" class="text-2xl hover:text-red-400">‚úï</button>
                </div>
                
                <div class="bg-red-500/20 border border-red-500 rounded-lg p-4 mb-4">
                    <p class="text-sm text-red-300">
                        <strong>ATTENTION:</strong> Ne partagez JAMAIS votre cl√© priv√©e.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Cl√© Priv√©e</label>
                        <input type="password" id="privateKeyInput" placeholder="0x..." class="w-full glass-effect rounded-lg px-4 py-3 focus:outline-none focus:border-red-400 border-2 border-gray-600 font-mono text-sm text-white">
                    </div>
                    
                    <button onclick="connectWithPrivateKey()" class="w-full px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 rounded-lg font-semibold transition-all">
                        üîì Connecter
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="glass-effect rounded-xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" style="color: #f59e0b;">üîç Console</h3>
                <button onclick="clearDebugLog()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold">
                    üóëÔ∏è Effacer
                </button>
            </div>
            <div id="debugConsole" class="bg-black/70 rounded-lg p-4 h-48 overflow-y-auto font-mono text-xs" style="border: 1px solid #f59e0b;">
                <p style="color: #f59e0b;">‚úÖ JERCAT Bot initialis√© - Auto-validation activ√©e</p>
                <p style="color: #10b981;">üíµ Mode USDT activ√© (trading USDT ‚Üí Tokens)</p>
            </div>
        </div>

        <!-- Crypto Selector -->
        <div id="cryptoSelector" class="glass-effect rounded-xl p-6 mb-6 border border-gray-500">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Crypto</label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full glass-effect rounded-lg px-4 py-3 focus:outline-none border-2 border-gray-600 text-lg font-semibold cursor-pointer text-white" style="border-color: #334155;">
                        <option>Chargement...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode Trading</label>
                    <div class="w-full glass-effect rounded-lg px-4 py-3 border-2 text-lg font-semibold text-center" style="border-color: #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.2));">
                        <span style="color: #f59e0b;">ü§ñ JERCAT AUTO-TRADING R√âEL (USDT)</span>
                    </div>
                </div>
            </div>
            
            <!-- Token personnalis√© -->
            <div class="border-t-2 border-gray-700 pt-4 mt-4">
                <label class="block text-sm text-gray-400 mb-2">üîç <span class="font-bold">Token personnalis√©</span> (adresse contrat BSC):</label>
                <div class="flex gap-3">
                    <input type="text" id="customTokenAddress" placeholder="0x..." class="flex-1 glass-effect rounded-lg px-4 py-3 focus:outline-none border-2 border-gray-600 font-mono text-sm text-white">
                    <button onclick="addCustomToken()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 rounded-lg font-semibold whitespace-nowrap">
                        ‚úÖ V√©rifier
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">üí° Exemple: 0x197CF8951d93325A9333857Ee5330daF7aC4bcCF (JERCAT)</p>
                <p class="text-xs text-yellow-500 mt-1">‚ö†Ô∏è V√©rifiez toujours l'adresse sur BscScan avant de trader!</p>
                
                <!-- Info token custom -->
                <div id="customTokenInfo" class="hidden mt-4 glass-effect rounded-lg p-4 border-2 border-green-500">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">‚úÖ</span>
                                <div>
                                    <p class="font-bold text-xl text-green-400" id="customTokenSymbol">-</p>
                                    <p class="text-sm text-gray-400" id="customTokenName">-</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 font-mono break-all" id="customTokenAddr">-</p>
                            <p class="text-sm text-gray-400 mt-2">D√©cimales: <span class="text-white font-bold" id="customTokenDecimals">-</span></p>
                        </div>
                        <button onclick="useCustomToken()" class="ml-4 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-lg font-semibold whitespace-nowrap">
                            üöÄ Trader
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capital -->
        <div id="capitalSection" class="glass-effect rounded-xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <h3 class="text-xl font-bold mb-4" style="color: #f59e0b;">üí∞ Capital (USDT)</h3>
            <div class="flex gap-4">
                <input type="number" id="capitalInput" placeholder="Ex: 100" value="100" class="flex-1 glass-effect rounded-lg px-4 py-3 focus:outline-none border-2 border-gray-600 text-white">
                <button onclick="setCapital()" class="px-8 py-3 rounded-lg font-semibold" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000;">
                    ‚úÖ D√©finir
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-effect rounded-xl p-4 border-2" style="border-color: #f59e0b;">
                <p class="text-xs text-gray-400">Capital</p>
                <p class="text-2xl font-bold" style="color: #f59e0b;"><span id="capitalDisplay">0</span> USDT</p>
            </div>
            
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Prix</p>
                <p class="text-2xl font-bold text-white">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Profit</p>
                <p class="text-2xl font-bold text-green-400"><span id="profitDisplay">0</span> USDT</p>
            </div>
            
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Win Rate</p>
                <p class="text-2xl font-bold text-white" id="winRateDisplay">0%</p>
            </div>
        </div>

        <!-- Signals -->
        <div class="glass-effect rounded-xl p-6 mb-6 border border-gray-500">
            <h3 class="text-xl font-bold mb-4" style="color: #f59e0b;">‚ö° Signaux (‚â•75%)</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-trend">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">EMA</span>
                        <span class="text-2xl" id="signal-trend-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="trend-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-rsi">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">RSI</span>
                        <span class="text-2xl" id="signal-rsi-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="rsi-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-macd">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">MACD</span>
                        <span class="text-2xl" id="signal-macd-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="macd-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-bollinger">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">BB</span>
                        <span class="text-2xl" id="signal-bollinger-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="bollinger-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-volume">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">Volume</span>
                        <span class="text-2xl" id="signal-volume-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="volume-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-volatility">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">ATR</span>
                        <span class="text-2xl" id="signal-volatility-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="volatility-display">--</p>
                </div>
            </div>

            <div class="rounded-xl p-4 border-2" style="background: linear-gradient(to right, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.2)); border-color: #f59e0b;">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-lg font-bold text-white">
                        Score: <span style="color: #f59e0b;" class="text-2xl" id="signal-score">0%</span>
                    </p>
                </div>
                <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-300" id="signal-progress" style="width: 0%; background: linear-gradient(to right, #dc2626, #fbbf24, #f59e0b);"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center" id="signal-status">En attente...</p>
            </div>
        </div>

        <!-- Chart & Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <h2 class="text-xl font-bold mb-4" style="color: #f59e0b;">üìà Graphique</h2>
                    <div class="h-48">
                        <canvas id="tradingChart"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" style="color: #f59e0b;">üìã Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">Start</span>
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö°</span>
                            <p>Aucun trade</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <h2 class="text-xl font-bold mb-4" style="color: #f59e0b;">‚öôÔ∏è Param√®tres</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">% par trade</label>
                            <input type="number" id="tradePercent" value="10" min="1" max="100" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">TP Mult</label>
                            <input type="number" id="tpMultiplier" value="3" min="1.5" max="5" step="0.25" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">SL Mult</label>
                            <input type="number" id="slMultiplier" value="1.5" min="0.5" max="3" step="0.25" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Score min (%)</label>
                            <input type="number" id="minScore" value="75" min="50" max="100" step="5" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div class="rounded-lg p-3 border-2" style="background: rgba(245, 158, 11, 0.2); border-color: #f59e0b;">
                            <p class="text-xs font-bold" style="color: #f59e0b;">‚úÖ Profit minimum: 3%</p>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <h3 class="text-lg font-bold mb-3" style="color: #f59e0b;">üìä Statut</h3>
                    <div class="space-y-2 text-sm">
                        <p>Wallet: <span id="walletStatus" class="text-red-400">üî¥ Non</span></p>
                        <p>Mode: <span id="modeStatus" class="text-gray-400">--</span></p>
                        <p>Position: <span id="positionStatus" class="text-gray-400">‚ö™ None</span></p>
                        <p>Trades: <span id="tradesCount" class="text-white">0</span></p>
                        <p>Auto-Validation: <span id="jercatStatus" style="color: #f59e0b;">‚è≥ En attente...</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ü§ñ JERCAT WALLET INTEGRATION
        function openJercatWallet() {
            debugLog('ü§ñ Ouverture du JERCAT Secure Wallet...', 'success');
            window.open('https://wallet-one-ochre.vercel.app/', '_blank', 'width=1200,height=800');
            debugLog('‚úÖ Wallet ouvert dans une nouvelle fen√™tre', 'info');
        }

        // Private Key Modal
        function togglePrivateKeyModal() {
            document.getElementById('privateKeyModal').classList.toggle('hidden');
        }

        const BSC_RPCS = [
            'https://bsc-dataseed.binance.org',
            'https://bsc-dataseed1.defibit.io'
        ];
        
        let state = {
            account: null,
            wallet: null,
            provider: null,
            isConnected: false,
            connectionMethod: null,
            selectedCrypto: 'BTCUSDT',
            customToken: null,
            currentPrice: 0,
            priceHistory: [],
            volumeHistory: [],
            tradingCapital: 0,
            initialCapital: 0,
            capitalSet: false,
            tradingMode: 'real',
            botRunning: false,
            isTrading: false,
            trades: [],
            portfolio: { profit: 0, wins: 0, losses: 0 },
            indicators: {},
            signals: {},
            currentPosition: null,
            lastBuyPrice: 0,
            lastMacdHist: 0,
            positionAmount: 0,
            entryFees: 0,
            minProfitPct: 3.0,
            jercatTrusted: false,
            usdtBalance: 0
        };

        function verifyRealMode() {
            if (!state.isConnected || !state.wallet) {
                alert('‚ö†Ô∏è ERREUR: Wallet non connect√©!\n\nCe bot fonctionne uniquement en MODE R√âEL.\nConnectez votre wallet MetaMask ou utilisez votre cl√© priv√©e.');
                return false;
            }
            return true;
        }

        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };
        
        const WBNB = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';
        const USDT = '0x55d398326f99059fF775485246999027B3197955';
        
        const USDT_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function balanceOf(address account) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];
        
        function getTokenAddress(symbol) {
            if (symbol && symbol.startsWith('CUSTOM_') && state.customToken) {
                return state.customToken.address;
            }
            return TOKEN_ADDRESSES[symbol] || WBNB;
        }

        async function addCustomToken() {
            const address = document.getElementById('customTokenAddress').value.trim();
            
            if (!address || !address.startsWith('0x') || address.length !== 42) {
                alert('‚ùå Adresse invalide! Format: 0x... (42 caract√®res)');
                return;
            }
            
            debugLog(`üîç V√©rification du token: ${address}...`, 'info');
            
            try {
                if (!state.provider) {
                    alert('‚ùå Connectez votre wallet d\'abord!');
                    return;
                }
                
                const network = await state.provider.getNetwork();
                if (network.chainId !== 56) {
                    alert('‚ùå Changez vers BSC Mainnet (ChainID 56)');
                    return;
                }
                
                const tokenContract = new ethers.Contract(
                    address,
                    [
                        'function name() view returns (string)',
                        'function symbol() view returns (string)',
                        'function decimals() view returns (uint8)'
                    ],
                    state.provider
                );
                
                debugLog('üì° R√©cup√©ration des infos...', 'info');
                const [name, symbol, decimals] = await Promise.all([
                    tokenContract.name(),
                    tokenContract.symbol(),
                    tokenContract.decimals()
                ]);
                
                state.customToken = {
                    address: address,
                    name: name,
                    symbol: symbol,
                    decimals: decimals
                };
                
                document.getElementById('customTokenSymbol').textContent = symbol;
                document.getElementById('customTokenName').textContent = name;
                document.getElementById('customTokenAddr').textContent = address;
                document.getElementById('customTokenDecimals').textContent = decimals;
                document.getElementById('customTokenInfo').classList.remove('hidden');
                
                debugLog(`‚úÖ Token trouv√©: ${symbol} (${name})`, 'success');
                debugLog(`üìä Adresse: ${address}`, 'info');
                debugLog(`üî¢ Decimals: ${decimals}`, 'info');
                
            } catch (error) {
                debugLog(`‚ùå Erreur: ${error.message}`, 'error');
                alert(`‚ùå Impossible de r√©cup√©rer les infos!\n\nV√©rifiez:\n- L'adresse est correcte\n- Le token existe sur BSC\n- Vous √™tes sur BSC Mainnet`);
            }
        }

        function useCustomToken() {
            if (!state.customToken) {
                alert('‚ùå Aucun token custom d√©fini!');
                return;
            }
            
            const customSymbol = `CUSTOM_${state.customToken.symbol}`;
            state.selectedCrypto = customSymbol;
            
            const sel = document.getElementById('cryptoSelect');
            const existingOption = Array.from(sel.options).find(opt => opt.value === customSymbol);
            if (!existingOption) {
                const option = document.createElement('option');
                option.value = customSymbol;
                option.textContent = `üéØ ${state.customToken.symbol} (Custom)`;
                sel.appendChild(option);
            }
            sel.value = customSymbol;
            
            debugLog(`üöÄ Trading activ√©: ${state.customToken.symbol}`, 'success');
            debugLog(`üìç Adresse: ${state.customToken.address}`, 'info');
            
            alert(`‚úÖ Token personnalis√© activ√©!\n\n${state.customToken.symbol} - ${state.customToken.name}\n\nD√©finissez votre capital et d√©marrez le bot!`);
        }

        let ws = null;
        let botInterval = null;
        let chart = null;

        window.establishJercatTrust = function(appName) {
            if (appName === 'jercat-bot' || appName === 'jercat-wallet' || appName === 'jercat-dex') {
                state.jercatTrusted = true;
                debugLog(`ü§ñ Confiance √©tablie: ${appName}`, 'success');
                debugLog('‚úÖ Trades AUTO-VALID√âS (pas de confirmation)', 'success');
                
                const statusDiv = document.getElementById('jercatStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                }
                
                const walletStatusDiv = document.getElementById('walletStatus');
                if (walletStatusDiv) {
                    walletStatusDiv.innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                }
                return true;
            }
            return false;
        };

        function debugLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('fr-FR');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : type === 'warning' ? 'text-yellow-400' : 'color: #f59e0b;';
            const console = document.getElementById('debugConsole');
            if (console) {
                const p = document.createElement('p');
                p.className = color;
                p.textContent = `[${time}] ${msg}`;
                console.appendChild(p);
                console.scrollTop = console.scrollHeight;
                if (console.children.length > 50) console.removeChild(console.firstChild);
            }
        }

        function clearDebugLog() {
            document.getElementById('debugConsole').innerHTML = '<p style="color: #f59e0b;">‚úÖ Console effac√©e - JERCAT Bot actif</p><p style="color: #10b981;">üíµ Mode USDT activ√©</p>';
        }

        window.addEventListener('DOMContentLoaded', () => {
            debugLog('ü§ñ JERCAT Trading Bot initialis√©', 'success');
            debugLog('üéØ Profit minimum: 3%', 'success');
            debugLog('üíµ Mode USDT activ√©', 'success');
            debugLog('üîó Int√©gration JERCAT Wallet active', 'info');
            
            if (document.referrer.includes('<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ JERCAT Trading Bot - Wallet Auto-Mode R√âEL (USDT)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            backdrop-filter: blur(10px);
            border: 1px solid #334155;
        }
        .gradient-text {
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 1000% 1000%;
            animation: gradient 30s linear infinite;
            font-weight: 900;
        }
        @keyframes gradient {
            0% { background-position: 0% center; }
            100% { background-position: 1000% center; }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass-effect rounded-2xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-5xl font-black gradient-text mb-2" style="text-shadow: 0 4px 8px rgba(0,0,0,0.8), 0 0 40px rgba(245, 158, 11, 0.6), 0 0 80px rgba(245, 158, 11, 0.4); transform: translateZ(0); filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.5));">
                        ü§ñ JERCAT Auto-Trading R√âEL
                    </h1>
                    <p class="text-gray-400">
                        ‚ö° Connexion Auto JERCAT Wallet ‚Ä¢ üéØ Mode R√âEL Blockchain ‚Ä¢ üî• Zero-Click Trading
                    </p>
                    <p class="text-green-400 font-bold text-sm mt-2">
                        ‚úÖ AUTO-VALIDATION JERCAT - Transactions automatiques sans confirmation
                    </p>
                    <p class="text-yellow-400 font-bold text-sm mt-1">
                        üíµ TRADING EN USDT (au lieu de BNB)
                    </p>
                </div>
                
                <div class="flex gap-2 flex-wrap">
                    <button onclick="openJercatWallet()" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all shadow-lg" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);">
                        <span>ü§ñ</span>
                        <span>JERCAT Wallet</span>
                    </button>
                    <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 shadow-lg">
                        <span>üëõ</span>
                        <span id="walletText">MetaMask</span>
                    </button>
                    <button onclick="togglePrivateKeyModal()" class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 shadow-lg">
                        <span>üîë</span>
                        <span>Cl√© Priv√©e</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Private Key Modal -->
        <div id="privateKeyModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-6 max-w-md w-full border-2 border-red-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-red-400">‚ö†Ô∏è Cl√© Priv√©e</h3>
                    <button onclick="togglePrivateKeyModal()" class="text-2xl hover:text-red-400">‚úï</button>
                </div>
                
                <div class="bg-red-500/20 border border-red-500 rounded-lg p-4 mb-4">
                    <p class="text-sm text-red-300">
                        <strong>ATTENTION:</strong> Ne partagez JAMAIS votre cl√© priv√©e.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Cl√© Priv√©e</label>
                        <input type="password" id="privateKeyInput" placeholder="0x..." class="w-full glass-effect rounded-lg px-4 py-3 focus:outline-none focus:border-red-400 border-2 border-gray-600 font-mono text-sm text-white">
                    </div>
                    
                    <button onclick="connectWithPrivateKey()" class="w-full px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 rounded-lg font-semibold transition-all">
                        üîì Connecter
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="glass-effect rounded-xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" style="color: #f59e0b;">üîç Console</h3>
                <button onclick="clearDebugLog()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold">
                    üóëÔ∏è Effacer
                </button>
            </div>
            <div id="debugConsole" class="bg-black/70 rounded-lg p-4 h-48 overflow-y-auto font-mono text-xs" style="border: 1px solid #f59e0b;">
                <p style="color: #f59e0b;">‚úÖ JERCAT Bot initialis√© - Auto-validation activ√©e</p>
                <p style="color: #10b981;">üíµ Mode USDT activ√© (trading USDT ‚Üí Tokens)</p>
            </div>
        </div>

        <!-- Crypto Selector -->
        <div id="cryptoSelector" class="glass-effect rounded-xl p-6 mb-6 border border-gray-500">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Crypto</label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full glass-effect rounded-lg px-4 py-3 focus:outline-none border-2 border-gray-600 text-lg font-semibold cursor-pointer text-white" style="border-color: #334155;">
                        <option>Chargement...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode Trading</label>
                    <div class="w-full glass-effect rounded-lg px-4 py-3 border-2 text-lg font-semibold text-center" style="border-color: #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.2));">
                        <span style="color: #f59e0b;">ü§ñ JERCAT AUTO-TRADING R√âEL (USDT)</span>
                    </div>
                </div>
            </div>
            
            <!-- Token personnalis√© -->
            <div class="border-t-2 border-gray-700 pt-4 mt-4">
                <label class="block text-sm text-gray-400 mb-2">üîç <span class="font-bold">Token personnalis√©</span> (adresse contrat BSC):</label>
                <div class="flex gap-3">
                    <input type="text" id="customTokenAddress" placeholder="0x..." class="flex-1 glass-effect rounded-lg px-4 py-3 focus:outline-none border-2 border-gray-600 font-mono text-sm text-white">
                    <button onclick="addCustomToken()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 rounded-lg font-semibold whitespace-nowrap">
                        ‚úÖ V√©rifier
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">üí° Exemple: 0x197CF8951d93325A9333857Ee5330daF7aC4bcCF (JERCAT)</p>
                <p class="text-xs text-yellow-500 mt-1">‚ö†Ô∏è V√©rifiez toujours l'adresse sur BscScan avant de trader!</p>
                
                <!-- Info token custom -->
                <div id="customTokenInfo" class="hidden mt-4 glass-effect rounded-lg p-4 border-2 border-green-500">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">‚úÖ</span>
                                <div>
                                    <p class="font-bold text-xl text-green-400" id="customTokenSymbol">-</p>
                                    <p class="text-sm text-gray-400" id="customTokenName">-</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 font-mono break-all" id="customTokenAddr">-</p>
                            <p class="text-sm text-gray-400 mt-2">D√©cimales: <span class="text-white font-bold" id="customTokenDecimals">-</span></p>
                        </div>
                        <button onclick="useCustomToken()" class="ml-4 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-lg font-semibold whitespace-nowrap">
                            üöÄ Trader
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capital -->
        <div id="capitalSection" class="glass-effect rounded-xl p-6 mb-6 border-2" style="border-color: #f59e0b;">
            <h3 class="text-xl font-bold mb-4" style="color: #f59e0b;">üí∞ Capital (USDT)</h3>
            <div class="flex gap-4">
                <input type="number" id="capitalInput" placeholder="Ex: 100" value="100" class="flex-1 glass-effect rounded-lg px-4 py-3 focus:outline-none border-2 border-gray-600 text-white">
                <button onclick="setCapital()" class="px-8 py-3 rounded-lg font-semibold" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #000;">
                    ‚úÖ D√©finir
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-effect rounded-xl p-4 border-2" style="border-color: #f59e0b;">
                <p class="text-xs text-gray-400">Capital</p>
                <p class="text-2xl font-bold" style="color: #f59e0b;"><span id="capitalDisplay">0</span> USDT</p>
            </div>
            
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Prix</p>
                <p class="text-2xl font-bold text-white">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Profit</p>
                <p class="text-2xl font-bold text-green-400"><span id="profitDisplay">0</span> USDT</p>
            </div>
            
            <div class="glass-effect rounded-xl p-4 border border-gray-500">
                <p class="text-xs text-gray-400">Win Rate</p>
                <p class="text-2xl font-bold text-white" id="winRateDisplay">0%</p>
            </div>
        </div>

        <!-- Signals -->
        <div class="glass-effect rounded-xl p-6 mb-6 border border-gray-500">
            <h3 class="text-xl font-bold mb-4" style="color: #f59e0b;">‚ö° Signaux (‚â•75%)</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-trend">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">EMA</span>
                        <span class="text-2xl" id="signal-trend-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="trend-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-rsi">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">RSI</span>
                        <span class="text-2xl" id="signal-rsi-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="rsi-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-macd">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">MACD</span>
                        <span class="text-2xl" id="signal-macd-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="macd-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-bollinger">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">BB</span>
                        <span class="text-2xl" id="signal-bollinger-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="bollinger-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-volume">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">Volume</span>
                        <span class="text-2xl" id="signal-volume-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="volume-display">--</p>
                </div>

                <div class="glass-effect border-2 border-slate-600 rounded-lg p-3" id="signal-volatility">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold" style="color: #f59e0b;">ATR</span>
                        <span class="text-2xl" id="signal-volatility-icon">‚ö™</span>
                    </div>
                    <p class="text-xs mt-1 font-mono text-gray-400" id="volatility-display">--</p>
                </div>
            </div>

            <div class="rounded-xl p-4 border-2" style="background: linear-gradient(to right, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.2)); border-color: #f59e0b;">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-lg font-bold text-white">
                        Score: <span style="color: #f59e0b;" class="text-2xl" id="signal-score">0%</span>
                    </p>
                </div>
                <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-300" id="signal-progress" style="width: 0%; background: linear-gradient(to right, #dc2626, #fbbf24, #f59e0b);"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center" id="signal-status">En attente...</p>
            </div>
        </div>

        <!-- Chart & Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <h2 class="text-xl font-bold mb-4" style="color: #f59e0b;">üìà Graphique</h2>
                    <div class="h-48">
                        <canvas id="tradingChart"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" style="color: #f59e0b;">üìã Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">Start</span>
                        </button>
                    </div>
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö°</span>
                            <p>Aucun trade</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <h2 class="text-xl font-bold mb-4" style="color: #f59e0b;">‚öôÔ∏è Param√®tres</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">% par trade</label>
                            <input type="number" id="tradePercent" value="10" min="1" max="100" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">TP Mult</label>
                            <input type="number" id="tpMultiplier" value="3" min="1.5" max="5" step="0.25" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">SL Mult</label>
                            <input type="number" id="slMultiplier" value="1.5" min="0.5" max="3" step="0.25" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Score min (%)</label>
                            <input type="number" id="minScore" value="75" min="50" max="100" step="5" class="w-full glass-effect rounded-lg px-3 py-2 text-sm border-2 border-gray-600 text-white">
                        </div>
                        <div class="rounded-lg p-3 border-2" style="background: rgba(245, 158, 11, 0.2); border-color: #f59e0b;">
                            <p class="text-xs font-bold" style="color: #f59e0b;">‚úÖ Profit minimum: 3%</p>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-xl p-6 border border-gray-500">
                    <h3 class="text-lg font-bold mb-3" style="color: #f59e0b;">üìä Statut</h3>
                    <div class="space-y-2 text-sm">
                        <p>Wallet: <span id="walletStatus" class="text-red-400">üî¥ Non</span></p>
                        <p>Mode: <span id="modeStatus" class="text-gray-400">--</span></p>
                        <p>Position: <span id="positionStatus" class="text-gray-400">‚ö™ None</span></p>
                        <p>Trades: <span id="tradesCount" class="text-white">0</span></p>
                        <p>Auto-Validation: <span id="jercatStatus" style="color: #f59e0b;">‚è≥ En attente...</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ü§ñ JERCAT WALLET INTEGRATION
        function openJercatWallet() {
            debugLog('ü§ñ Ouverture du JERCAT Secure Wallet...', 'success');
            window.open('https://test-seven-mu-77.vercel.app/', '_blank', 'width=1200,height=800');
            debugLog('‚úÖ Wallet ouvert dans une nouvelle fen√™tre', 'info');
        }

        // Private Key Modal
        function togglePrivateKeyModal() {
            document.getElementById('privateKeyModal').classList.toggle('hidden');
        }

        const BSC_RPCS = [
            'https://bsc-dataseed.binance.org',
            'https://bsc-dataseed1.defibit.io'
        ];
        
        let state = {
            account: null,
            wallet: null,
            provider: null,
            isConnected: false,
            connectionMethod: null,
            selectedCrypto: 'BTCUSDT',
            customToken: null,
            currentPrice: 0,
            priceHistory: [],
            volumeHistory: [],
            tradingCapital: 0,
            initialCapital: 0,
            capitalSet: false,
            tradingMode: 'real',
            botRunning: false,
            isTrading: false,
            trades: [],
            portfolio: { profit: 0, wins: 0, losses: 0 },
            indicators: {},
            signals: {},
            currentPosition: null,
            lastBuyPrice: 0,
            lastMacdHist: 0,
            positionAmount: 0,
            entryFees: 0,
            minProfitPct: 3.0,
            jercatTrusted: false,
            usdtBalance: 0
        };

        function verifyRealMode() {
            if (!state.isConnected || !state.wallet) {
                alert('‚ö†Ô∏è ERREUR: Wallet non connect√©!\n\nCe bot fonctionne uniquement en MODE R√âEL.\nConnectez votre wallet MetaMask ou utilisez votre cl√© priv√©e.');
                return false;
            }
            return true;
        }

        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c'
        };
        
        const WBNB = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';
        const USDT = '0x55d398326f99059fF775485246999027B3197955';
        
        const USDT_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function balanceOf(address account) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];
        
        function getTokenAddress(symbol) {
            if (symbol && symbol.startsWith('CUSTOM_') && state.customToken) {
                return state.customToken.address;
            }
            return TOKEN_ADDRESSES[symbol] || WBNB;
        }

        async function addCustomToken() {
            const address = document.getElementById('customTokenAddress').value.trim();
            
            if (!address || !address.startsWith('0x') || address.length !== 42) {
                alert('‚ùå Adresse invalide! Format: 0x... (42 caract√®res)');
                return;
            }
            
            debugLog(`üîç V√©rification du token: ${address}...`, 'info');
            
            try {
                if (!state.provider) {
                    alert('‚ùå Connectez votre wallet d\'abord!');
                    return;
                }
                
                const network = await state.provider.getNetwork();
                if (network.chainId !== 56) {
                    alert('‚ùå Changez vers BSC Mainnet (ChainID 56)');
                    return;
                }
                
                const tokenContract = new ethers.Contract(
                    address,
                    [
                        'function name() view returns (string)',
                        'function symbol() view returns (string)',
                        'function decimals() view returns (uint8)'
                    ],
                    state.provider
                );
                
                debugLog('üì° R√©cup√©ration des infos...', 'info');
                const [name, symbol, decimals] = await Promise.all([
                    tokenContract.name(),
                    tokenContract.symbol(),
                    tokenContract.decimals()
                ]);
                
                state.customToken = {
                    address: address,
                    name: name,
                    symbol: symbol,
                    decimals: decimals
                };
                
                document.getElementById('customTokenSymbol').textContent = symbol;
                document.getElementById('customTokenName').textContent = name;
                document.getElementById('customTokenAddr').textContent = address;
                document.getElementById('customTokenDecimals').textContent = decimals;
                document.getElementById('customTokenInfo').classList.remove('hidden');
                
                debugLog(`‚úÖ Token trouv√©: ${symbol} (${name})`, 'success');
                debugLog(`üìä Adresse: ${address}`, 'info');
                debugLog(`üî¢ Decimals: ${decimals}`, 'info');
                
            } catch (error) {
                debugLog(`‚ùå Erreur: ${error.message}`, 'error');
                alert(`‚ùå Impossible de r√©cup√©rer les infos!\n\nV√©rifiez:\n- L'adresse est correcte\n- Le token existe sur BSC\n- Vous √™tes sur BSC Mainnet`);
            }
        }

        function useCustomToken() {
            if (!state.customToken) {
                alert('‚ùå Aucun token custom d√©fini!');
                return;
            }
            
            const customSymbol = `CUSTOM_${state.customToken.symbol}`;
            state.selectedCrypto = customSymbol;
            
            const sel = document.getElementById('cryptoSelect');
            const existingOption = Array.from(sel.options).find(opt => opt.value === customSymbol);
            if (!existingOption) {
                const option = document.createElement('option');
                option.value = customSymbol;
                option.textContent = `üéØ ${state.customToken.symbol} (Custom)`;
                sel.appendChild(option);
            }
            sel.value = customSymbol;
            
            debugLog(`üöÄ Trading activ√©: ${state.customToken.symbol}`, 'success');
            debugLog(`üìç Adresse: ${state.customToken.address}`, 'info');
            
            alert(`‚úÖ Token personnalis√© activ√©!\n\n${state.customToken.symbol} - ${state.customToken.name}\n\nD√©finissez votre capital et d√©marrez le bot!`);
        }

        let ws = null;
        let botInterval = null;
        let chart = null;

        window.establishJercatTrust = function(appName) {
            if (appName === 'jercat-bot' || appName === 'jercat-wallet' || appName === 'jercat-dex') {
                state.jercatTrusted = true;
                debugLog(`ü§ñ Confiance √©tablie: ${appName}`, 'success');
                debugLog('‚úÖ Trades AUTO-VALID√âS (pas de confirmation)', 'success');
                
                const statusDiv = document.getElementById('jercatStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                }
                
                const walletStatusDiv = document.getElementById('walletStatus');
                if (walletStatusDiv) {
                    walletStatusDiv.innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                }
                return true;
            }
            return false;
        };

        function debugLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('fr-FR');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : type === 'warning' ? 'text-yellow-400' : 'color: #f59e0b;';
            const console = document.getElementById('debugConsole');
            if (console) {
                const p = document.createElement('p');
                p.className = color;
                p.textContent = `[${time}] ${msg}`;
                console.appendChild(p);
                console.scrollTop = console.scrollHeight;
                if (console.children.length > 50) console.removeChild(console.firstChild);
            }
        }

        function clearDebugLog() {
            document.getElementById('debugConsole').innerHTML = '<p style="color: #f59e0b;">‚úÖ Console effac√©e - JERCAT Bot actif</p><p style="color: #10b981;">üíµ Mode USDT activ√©</p>';
        }

        window.addEventListener('DOMContentLoaded', () => {
            debugLog('ü§ñ JERCAT Trading Bot initialis√©', 'success');
            debugLog('üéØ Profit minimum: 3%', 'success');
            debugLog('üíµ Mode USDT activ√©', 'success');
            debugLog('üîó Int√©gration JERCAT Wallet active', 'info');
            
            if (document.referrer.includes('wallet-one-ochre.vercel.app') || 
                document.referrer.includes('jercat-wallet') ||
                document.referrer.includes('localhost')) {
                state.jercatTrusted = true;
                debugLog('ü§ñ JERCAT Wallet d√©tect√© via referrer', 'success');
                debugLog('‚úÖ Mode AUTO-VALIDATION activ√©', 'success');
                document.getElementById('jercatStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
            }
            
            if (window.opener) {
                state.jercatTrusted = true;
                debugLog('ü§ñ Ouvert par JERCAT Wallet', 'success');
                debugLog('‚úÖ Mode AUTO-VALIDATION activ√©', 'success');
                document.getElementById('jercatStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
            }
            
            initChart();
            loadCryptos();
        });

        window.addEventListener('message', async (event) => {
            if (!event.origin.includes('wallet-one-ochre.vercel.app') && 
                !event.origin.includes('localhost') &&
                !event.origin.includes('jercat-wallet')) {
                return;
            }

            const data = event.data;
            
            if (data.type === 'JERCAT_WALLET_CONNECTED') {
                debugLog('üì® Message re√ßu du JERCAT Wallet', 'success');
                debugLog(`üìç Adresse: ${data.account.slice(0, 10)}...`, 'info');
                
                state.jercatTrusted = true;
                document.getElementById('jercatStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                
                if (data.privateKey) {
                    try {
                        debugLog('üîë Cl√© priv√©e re√ßue - Connexion automatique...', 'info');
                        
                        state.provider = new ethers.providers.JsonRpcProvider(BSC_RPCS[0]);
                        
                        const key = data.privateKey.startsWith('0x') ? data.privateKey : '0x' + data.privateKey;
                        state.wallet = new ethers.Wallet(key, state.provider);
                        state.account = state.wallet.address;
                        state.isConnected = true;
                        state.connectionMethod = 'jercat-wallet';
                        
                        debugLog(`‚úÖ Connect√© automatiquement: ${state.account.slice(0, 10)}...`, 'success');
                        debugLog('ü§ñ Mode AUTO-TRADING R√âEL activ√© !', 'success');
                        debugLog('üî• Zero-Click Trading : Trades ex√©cut√©s automatiquement', 'success');
                        
                        updateUI();
                        await updateBalance();
                        
                        document.getElementById('cryptoSelector').classList.remove('hidden');
                        document.getElementById('capitalSection').classList.remove('hidden');
                        document.getElementById('statsCards').classList.remove('hidden');
                        
                        alert('‚úÖ Connexion JERCAT Wallet r√©ussie !\n\nü§ñ Auto-Trading R√âEL activ√©\nüìç ' + state.account.slice(0, 20) + '...\n\nüî• Trades sans confirmation');
                        
                    } catch (error) {
                        debugLog(`‚ùå Erreur connexion auto: ${error.message}`, 'error');
                    }
                    
                } else {
                    state.account = data.account;
                    state.isConnected = false;
                    debugLog('üëÅÔ∏è Mode lecture seule (adresse uniquement)', 'info');
                    updateUI();
                }
            }
        });

        function initChart() {
            const ctx = document.getElementById('tradingChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#f59e0b',
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: true, grid: { color: 'rgba(245, 158, 11, 0.1)' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask non install√©');
                return;
            }
            try {
                debugLog('üîÑ Connexion MetaMask...', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.wallet = state.provider.getSigner();
                state.isConnected = true;
                state.connectionMethod = 'metamask';
                
                debugLog(`‚úÖ Connect√©: ${state.account.slice(0, 6)}...`, 'success');
                
                document.getElementById('cryptoSelector').classList.remove('hidden');
                document.getElementById('capitalSection').classList.remove('hidden');
                updateUI();
                
                await updateBalance();
            } catch (error) {
                debugLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function connectWithPrivateKey() {
            const pk = document.getElementById('privateKeyInput').value.trim();
            if (!pk) {
                alert('‚ùå Entrez votre cl√© priv√©e');
                return;
            }
            try {
                debugLog('üîÑ Connexion avec cl√© priv√©e...', 'info');
                
                state.provider = new ethers.providers.JsonRpcProvider(BSC_RPCS[0]);
                
                const key = pk.startsWith('0x') ? pk : '0x' + pk;
                state.wallet = new ethers.Wallet(key, state.provider);
                state.account = state.wallet.address;
                state.isConnected = true;
                state.connectionMethod = 'privatekey';
                
                debugLog(`‚úÖ Connect√©: ${state.account.slice(0, 6)}...`, 'success');
                
                togglePrivateKeyModal();
                document.getElementById('privateKeyInput').value = '';
                
                document.getElementById('cryptoSelector').classList.remove('hidden');
                document.getElementById('capitalSection').classList.remove('hidden');
                updateUI();
                
                await updateBalance();
            } catch (error) {
                debugLog(`‚ùå Erreur: ${error.message}`, 'error');
                alert(`‚ùå Cl√© priv√©e invalide`);
            }
        }

        function loadCryptos() {
            const cryptos = [
                { symbol: 'BTCUSDT', name: 'BTC' },
                { symbol: 'ETHUSDT', name: 'ETH' },
                { symbol: 'BNBUSDT', name: 'BNB' }
            ];
            document.getElementById('cryptoSelect').innerHTML = cryptos.map(c => 
                `<option value="${c.symbol}">${c.name}</option>`
            ).join('');
            state.selectedCrypto = cryptos[0].symbol;
            connectWebSocket();
        }

        function changeCrypto() {
            state.selectedCrypto = document.getElementById('cryptoSelect').value;
            debugLog(`üîÑ Crypto: ${state.selectedCrypto}`, 'info');
            connectWebSocket();
        }

        function changeTradingMode() {
            state.tradingMode = 'real';
            debugLog('üîí Mode R√âEL fixe activ√©', 'warning');
        }

        function connectWebSocket() {
            if (ws) ws.close();
            const symbol = state.selectedCrypto.toLowerCase();
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@ticker`);
            
            ws.onopen = () => debugLog(`üü¢ WebSocket: ${state.selectedCrypto}`, 'success');
            
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                state.currentPrice = parseFloat(data.c);
                const volume = parseFloat(data.v);
                
                state.priceHistory.push(state.currentPrice);
                state.volumeHistory.push(volume);
                
                if (state.priceHistory.length > 200) state.priceHistory.shift();
                if (state.volumeHistory.length > 50) state.volumeHistory.shift();
                
                if (state.priceHistory.length >= 50) updateIndicators();
                if (state.priceHistory.length % 5 === 0) updateChart();
                
                document.getElementById('currentPrice').textContent = state.currentPrice.toFixed(2);
            };
        }

        function calculateEMA(prices, period) {
            if (prices.length === 0) return 0;
            const k = 2 / (period + 1);
            let ema = prices[0];
            for (let i = 1; i < prices.length; i++) {
                ema = (prices[i] - ema) * k + ema;
            }
            return ema;
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + avgGain / avgLoss));
        }

        function calculateMACD(prices) {
            if (prices.length < 26) return { macd: 0, hist: 0 };
            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);
            const macd = ema12 - ema26;
            const macdLine = [];
            for (let i = 26; i <= prices.length; i++) {
                const slice = prices.slice(0, i);
                const e12 = calculateEMA(slice, 12);
                const e26 = calculateEMA(slice, 26);
                macdLine.push(e12 - e26);
            }
            const signal = calculateEMA(macdLine, 9);
            return { macd, hist: macd - signal };
        }

        function calculateBB(prices, period = 20, stdDev = 2) {
            if (prices.length < period) return { upper: 0, lower: 0 };
            const slice = prices.slice(-period);
            const avg = slice.reduce((a, b) => a + b, 0) / period;
            const variance = slice.reduce((sum, p) => sum + Math.pow(p - avg, 2), 0) / period;
            const std = Math.sqrt(variance);
            return {
                upper: avg + (std * stdDev),
                lower: avg - (std * stdDev)
            };
        }

        function calculateATR(prices, period = 14) {
            if (prices.length < period + 1) return 0;
            let sum = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const high = prices[i] * 1.01;
                const low = prices[i] * 0.99;
                const prev = i > 0 ? prices[i - 1] : prices[i];
                sum += Math.max(high - low, Math.abs(high - prev), Math.abs(low - prev));
            }
            return sum / period;
        }

        function updateIndicators() {
            if (state.priceHistory.length < 50) return;
            
            state.indicators.ema9 = calculateEMA(state.priceHistory, 9);
            state.indicators.ema21 = calculateEMA(state.priceHistory, 21);
            state.indicators.ema50 = calculateEMA(state.priceHistory, 50);
            state.indicators.rsi = calculateRSI(state.priceHistory, 14);
            
            const macd = calculateMACD(state.priceHistory);
            state.lastMacdHist = state.indicators.macdHist || 0;
            state.indicators.macd = macd.macd;
            state.indicators.macdHist = macd.hist;
            
            const bb = calculateBB(state.priceHistory, 20, 2);
            state.indicators.bbUpper = bb.upper;
            state.indicators.bbLower = bb.lower;
            state.indicators.atr = calculateATR(state.priceHistory, 14);
            
            if (state.volumeHistory.length >= 20) {
                state.indicators.volumeAvg = state.volumeHistory.slice(-20).reduce((a, b) => a + b, 0) / 20;
            }
            state.indicators.volume = state.volumeHistory[state.volumeHistory.length - 1] || 0;
            
            updateSignals();
        }

        function updateSignals() {
            const { ema9, ema21, ema50, rsi, macdHist, bbUpper, bbLower, volume, volumeAvg, atr } = state.indicators;
            
            state.signals.trend = ema9 > ema21 && ema21 > ema50;
            state.signals.rsi = rsi >= 25 && rsi <= 45;
            state.signals.macd = macdHist > 0 && state.lastMacdHist <= 0;
            
            const distBB = ((state.currentPrice - bbLower) / bbLower) * 100;
            state.signals.bollinger = distBB >= -0.5 && distBB <= 2;
            
            state.signals.volume = volume > volumeAvg * 1.5;
            
            const atrPct = (atr / state.currentPrice) * 100;
            state.signals.volatility = atrPct > 1 && atrPct < 4;
            
            updateSignalUI('trend', state.signals.trend, `${ema9.toFixed(2)}`);
            updateSignalUI('rsi', state.signals.rsi, `${rsi.toFixed(1)}`);
            updateSignalUI('macd', state.signals.macd, `${macdHist.toFixed(4)}`);
            updateSignalUI('bollinger', state.signals.bollinger, `${distBB.toFixed(2)}%`);
            updateSignalUI('volume', state.signals.volume, `${volumeAvg > 0 ? (volume / volumeAvg * 100).toFixed(0) : 100}%`);
            updateSignalUI('volatility', state.signals.volatility, `${atrPct.toFixed(2)}%`);
            
            const signals = Object.values(state.signals);
            const score = Math.round((signals.filter(s => s).length / signals.length) * 100);
            const minScore = parseInt(document.getElementById('minScore').value);
            
            document.getElementById('signal-score').textContent = score + '%';
            document.getElementById('signal-progress').style.width = score + '%';
            document.getElementById('signal-status').textContent = score >= minScore ? '‚úÖ Signal BUY!' : `‚è≥ ${score}%`;
        }

        function updateSignalUI(name, isValid, value) {
            const icon = document.getElementById(`signal-${name}-icon`);
            const display = document.getElementById(`${name}-display`);
            const container = document.getElementById(`signal-${name}`);
            if (icon) icon.textContent = isValid ? '‚úÖ' : '‚ö™';
            if (display) display.textContent = value;
            if (container) {
                container.className = isValid ? 'bg-green-500/30 border-2 border-green-500 rounded-lg p-3' : 'glass-effect border-2 border-slate-600 rounded-lg p-3';
            }
        }

        function updateChart() {
            if (!chart || state.priceHistory.length === 0) return;
            const maxPoints = 50;
            const prices = state.priceHistory.slice(-maxPoints);
            const labels = prices.map((_, i) => {
                const date = new Date(Date.now() - (maxPoints - i) * 10000);
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            });
            chart.data.labels = labels;
            chart.data.datasets[0].data = prices;
            chart.update('none');
        }

        function setCapital() {
            const cap = parseFloat(document.getElementById('capitalInput').value);
            if (!cap || cap <= 0) {
                alert('‚ùå Montant invalide');
                return;
            }
            state.tradingCapital = cap;
            state.initialCapital = cap;
            state.capitalSet = true;
            debugLog(`‚úÖ Capital: ${cap} USDT`, 'success');
            
            document.getElementById('capitalSection').classList.add('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('capitalDisplay').textContent = cap.toFixed(2);
            document.getElementById('toggleBotBtn').disabled = false;
            document.getElementById('toggleBotBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-green-600 hover:bg-green-700';
            
            updateUI();
        }

        function toggleBot() {
            state.botRunning = !state.botRunning;
            if (state.botRunning) {
                startBot();
            } else {
                stopBot();
            }
            updateUI();
        }

        function startBot() {
            if (!verifyRealMode()) {
                return;
            }
            
            debugLog('üöÄ BOT D√âMARR√â - MODE R√âEL', 'success');
            debugLog(`üí∞ Capital: ${state.tradingCapital} USDT`, 'info');
            debugLog(`‚ö†Ô∏è TRANSACTIONS BLOCKCHAIN R√âELLES!`, 'warning');
            if (state.jercatTrusted) {
                debugLog('ü§ñ Mode AUTO-VALIDATION: Trades sans confirmation', 'success');
            }
            
            botInterval = setInterval(() => {
                if (state.priceHistory.length < 50) {
                    debugLog(`‚è≥ Collecte donn√©es: ${state.priceHistory.length}/50`, 'warning');
                    return;
                }
                
                updateIndicators();
                const signal = getTradeSignal();
                
                if (signal.signal && !state.isTrading) {
                    executeTrade(signal.signal, signal.score, signal.reason);
                }
            }, 3000);
        }

        function stopBot() {
            if (botInterval) {
                clearInterval(botInterval);
                botInterval = null;
                debugLog('üõë BOT ARR√äT√â', 'warning');
                const ret = ((state.tradingCapital - state.initialCapital) / state.initialCapital * 100);
                debugLog(`üìä Performance: ${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%`, ret >= 0 ? 'success' : 'error');
            }
        }

        function getTradeSignal() {
            const minScore = parseInt(document.getElementById('minScore').value);
            
            if (!state.currentPosition) {
                const signals = Object.values(state.signals);
                const score = Math.round((signals.filter(s => s).length / signals.length) * 100);
                if (score >= minScore) {
                    const reasons = [];
                    if (state.signals.trend) reasons.push('EMA‚Üë');
                    if (state.signals.rsi) reasons.push(`RSI:${state.indicators.rsi.toFixed(0)}`);
                    if (state.signals.macd) reasons.push('MACD‚úì');
                    return { signal: 'BUY', score, reason: reasons.join('|') };
                }
                return { signal: null, score: 0 };
            } else {
                const profitPct = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                const atrPct = (state.indicators.atr / state.lastBuyPrice) * 100;
                const tpMult = parseFloat(document.getElementById('tpMultiplier').value);
                const slMult = parseFloat(document.getElementById('slMultiplier').value);
                
                const dynamicTP = atrPct * tpMult;
                const dynamicSL = -atrPct * slMult;
                
                if (profitPct >= state.minProfitPct) {
                    debugLog(`üíé Profit atteint: ${profitPct.toFixed(2)}% (min: ${state.minProfitPct}%)`, 'success');
                    return { signal: 'SELL', score: 100, reason: `Profit +${profitPct.toFixed(2)}%` };
                }
                
                if (profitPct <= dynamicSL) {
                    return { signal: 'SELL', score: 100, reason: `SL ${dynamicSL.toFixed(2)}%` };
                }
                
                if (profitPct >= dynamicTP) {
                    return { signal: 'SELL', score: 100, reason: `TP +${dynamicTP.toFixed(2)}%` };
                }
                
                if (state.indicators.rsi > 75 && profitPct > 0.5) {
                    return { signal: 'SELL', score: 100, reason: `RSI:${state.indicators.rsi.toFixed(0)}` };
                }
                
                return { signal: null, score: 0 };
            }
        }

        async function executeTrade(tradeType, score, reason) {
            state.isTrading = true;
            
            debugLog(`${tradeType === 'BUY' ? 'üü¢' : 'üî¥'} ${tradeType} - ${reason}`, tradeType === 'BUY' ? 'success' : 'warning');
            
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const tradeAmount = (state.tradingCapital * percent) / 100;
            
            let netProfit = 0;
            let actualFees = 0;
            
            if (!state.isConnected || !state.wallet) {
                debugLog(`‚ùå ERREUR: Wallet non connect√©!`, 'error');
                alert('‚ö†Ô∏è Connectez votre wallet pour trader en MODE R√âEL');
                state.isTrading = false;
                return;
            }
            
            try {
                const network = await state.provider.getNetwork();
                if (network.chainId !== 56) {
                    debugLog(`‚ùå ERREUR: Mauvais network! ChainID: ${network.chainId}`, 'error');
                    alert(`‚ö†Ô∏è Changez vers BSC Mainnet!\n\nNetwork actuel: ${network.name} (${network.chainId})\nRequis: BSC Mainnet (56)`);
                    state.isTrading = false;
                    return;
                }
                
                // üíµ V√âRIFIER LA BALANCE USDT
                const usdtContract = new ethers.Contract(USDT, USDT_ABI, state.provider);
                const usdtBalance = await usdtContract.balanceOf(state.account);
                const usdtBalanceFormatted = parseFloat(ethers.utils.formatUnits(usdtBalance, 18));
                
                debugLog(`üí∞ Balance USDT: ${usdtBalanceFormatted.toFixed(2)} USDT`, 'info');
                state.usdtBalance = usdtBalanceFormatted;
                
                if (tradeType === 'BUY') {
                    if (usdtBalanceFormatted < tradeAmount) {
                        debugLog(`‚ùå Balance USDT insuffisante!`, 'error');
                        debugLog(`üí∞ Requis: ${tradeAmount.toFixed(2)} USDT`, 'error');
                        debugLog(`üí∞ Disponible: ${usdtBalanceFormatted.toFixed(2)} USDT`, 'error');
                        alert(`‚ùå Balance USDT insuffisante!\n\nTrade: ${tradeAmount.toFixed(2)} USDT\nDisponible: ${usdtBalanceFormatted.toFixed(2)} USDT\n\nüí° R√©duisez votre capital ou le % par trade!`);
                        state.isTrading = false;
                        return;
                    }
                }
                
                debugLog('üîó Ex√©cution BLOCKCHAIN sur BSC...', 'warning');
                debugLog(`üí∞ Montant du trade: ${tradeAmount.toFixed(2)} USDT`, 'info');
                
                const tokenAddress = getTokenAddress(state.selectedCrypto);
                const amountInWei = ethers.utils.parseUnits(tradeAmount.toFixed(6), 18);
                
                const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
                
                if (tradeType === 'BUY') {
                    debugLog('üí∞ Achat via PancakeSwap (USDT ‚Üí Token)...', 'info');
                    debugLog(`üéØ Token: ${tokenAddress}`, 'info');
                    
                    // 1Ô∏è‚É£ Approuver USDT pour le router
                    debugLog('üìù Approbation USDT...', 'info');
                    const usdtContractSigner = new ethers.Contract(USDT, USDT_ABI, state.wallet);
                    const approveTx = await usdtContractSigner.approve(PANCAKE_ROUTER, amountInWei);
                    debugLog(`‚è≥ Approbation: ${approveTx.hash.slice(0, 10)}...`, 'info');
                    await approveTx.wait();
                    debugLog(`‚úÖ USDT approuv√©`, 'success');
                    
                    // 2Ô∏è‚É£ Swap USDT ‚Üí Token
                    const routerABI = [
                        'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
                    ];
                    
                    const router = new ethers.Contract(PANCAKE_ROUTER, routerABI, state.wallet);
                    
                    const path = [USDT, tokenAddress];
                    const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                    const amountOutMin = 0;
                    
                    debugLog('üìù Pr√©paration du swap USDT ‚Üí Token...', 'info');
                    
                    let gasLimit;
                    try {
                        const estimatedGas = await router.estimateGas.swapExactTokensForTokens(
                            amountInWei,
                            amountOutMin,
                            path,
                            state.account,
                            deadline
                        );
                        gasLimit = estimatedGas.mul(120).div(100);
                        debugLog(`‚õΩ Gas estim√©: ${estimatedGas.toString()}`, 'info');
                    } catch (error) {
                        debugLog(`‚ö†Ô∏è Impossible d'estimer le gas, utilisation de 300000`, 'warning');
                        gasLimit = ethers.BigNumber.from('300000');
                    }
                    
                    const tx = await router.swapExactTokensForTokens(
                        amountInWei,
                        amountOutMin,
                        path,
                        state.account,
                        deadline,
                        { gasLimit: gasLimit }
                    );
                    
                    debugLog(`‚è≥ Transaction envoy√©e: ${tx.hash.slice(0, 10)}...`, 'info');
                    debugLog(`üîó BscScan: https://bscscan.com/tx/${tx.hash}`, 'success');
                    
                    const receipt = await tx.wait();
                    debugLog(`‚úÖ Transaction confirm√©e! Bloc: ${receipt.blockNumber}`, 'success');
                    
                    actualFees = parseFloat(ethers.utils.formatEther(receipt.gasUsed.mul(receipt.effectiveGasPrice)));
                    debugLog(`‚õΩ Frais gas: ${actualFees.toFixed(6)} BNB`, 'info');
                    
                } else {
                    debugLog('üí∏ Vente via PancakeSwap (Token ‚Üí USDT)...', 'info');
                    
                    const routerABI = [
                        'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
                    ];
                    
                    const tokenABI = [
                        'function approve(address spender, uint256 amount) external returns (bool)',
                        'function balanceOf(address account) view returns (uint256)'
                    ];
                    
                    const tokenContract = new ethers.Contract(tokenAddress, tokenABI, state.wallet);
                    const tokenBalance = await tokenContract.balanceOf(state.account);
                    
                    debugLog(`üìä Balance token: ${ethers.utils.formatEther(tokenBalance)}`, 'info');
                    
                    if (tokenBalance.isZero()) {
                        debugLog(`‚ùå Aucun token √† vendre!`, 'error');
                        alert('‚ùå Aucun token dans votre wallet!');
                        state.isTrading = false;
                        return;
                    }
                    
                    debugLog('üìù Approbation du router...', 'info');
                    const approveTx = await tokenContract.approve(PANCAKE_ROUTER, tokenBalance);
                    debugLog(`‚è≥ Approbation: ${approveTx.hash.slice(0, 10)}...`, 'info');
                    await approveTx.wait();
                    debugLog(`‚úÖ Approbation confirm√©e`, 'success');
                    
                    const router = new ethers.Contract(PANCAKE_ROUTER, routerABI, state.wallet);
                    const path = [tokenAddress, USDT];
                    const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                    const amountOutMin = 0;
                    
                    debugLog('üìù Pr√©paration de la vente (Token ‚Üí USDT)...', 'info');
                    
                    let gasLimit;
                    try {
                        const estimatedGas = await router.estimateGas.swapExactTokensForTokens(
                            tokenBalance,
                            amountOutMin,
                            path,
                            state.account,
                            deadline
                        );
                        gasLimit = estimatedGas.mul(120).div(100);
                        debugLog(`‚õΩ Gas estim√©: ${estimatedGas.toString()}`, 'info');
                    } catch (error) {
                        debugLog(`‚ö†Ô∏è Impossible d'estimer le gas, utilisation de 300000`, 'warning');
                        gasLimit = ethers.BigNumber.from('300000');
                    }
                    
                    const tx = await router.swapExactTokensForTokens(
                        tokenBalance,
                        amountOutMin,
                        path,
                        state.account,
                        deadline,
                        { gasLimit: gasLimit }
                    );
                    
                    debugLog(`‚è≥ Transaction envoy√©e: ${tx.hash.slice(0, 10)}...`, 'info');
                    debugLog(`üîó BscScan: https://bscscan.com/tx/${tx.hash}`, 'success');
                    
                    const receipt = await tx.wait();
                    debugLog(`‚úÖ Transaction confirm√©e! Bloc: ${receipt.blockNumber}`, 'success');
                    
                    actualFees = parseFloat(ethers.utils.formatEther(receipt.gasUsed.mul(receipt.effectiveGasPrice)));
                    debugLog(`‚õΩ Frais gas: ${actualFees.toFixed(6)} BNB`, 'info');
                }
                
            } catch (error) {
                debugLog(`‚ùå ERREUR BLOCKCHAIN: ${error.message}`, 'error');
                
                if (error.message.includes('insufficient funds')) {
                    alert('‚ùå Fonds insuffisants!\n\nV√©rifiez votre balance USDT.\n\nüí° R√©duisez votre capital ou le % par trade!');
                } else if (error.message.includes('user rejected')) {
                    alert('‚ùå Transaction rejet√©e par l\'utilisateur');
                } else if (error.message.includes('INSUFFICIENT_OUTPUT_AMOUNT')) {
                    alert('‚ùå Slippage trop √©lev√©!\n\nLe prix a trop boug√©. R√©essayez.');
                } else {
                    alert(`‚ùå Erreur: ${error.message.slice(0, 100)}`);
                }
                
                state.isTrading = false;
                return;
            }
            
            if (tradeType === 'BUY') {
                if (tradeAmount > state.tradingCapital) {
                    debugLog(`‚ùå Capital insuffisant`, 'error');
                    state.isTrading = false;
                    return;
                }
                
                state.tradingCapital -= tradeAmount;
                state.currentPosition = 'BUY';
                state.lastBuyPrice = state.currentPrice;
                state.positionAmount = tradeAmount;
                state.entryFees = actualFees;
                
                debugLog(`üìà POSITION OUVERTE`, 'success');
                debugLog(`üíµ Montant: ${state.positionAmount.toFixed(2)} USDT`, 'info');
                
            } else {
                const profitPct = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                const grossProfit = state.positionAmount * (profitPct / 100);
                netProfit = grossProfit;
                
                state.tradingCapital += state.positionAmount + grossProfit;
                
                debugLog(`üìâ POSITION FERM√âE`, netProfit >= 0 ? 'success' : 'error');
                debugLog(`üíé NET: ${netProfit >= 0 ? '+' : ''}${netProfit.toFixed(2)} USDT`, netProfit >= 0 ? 'success' : 'error');
                
                state.currentPosition = null;
                state.entryFees = 0;
                
                if (netProfit > 0) state.portfolio.wins++;
                else state.portfolio.losses++;
                state.portfolio.profit += netProfit;
            }
            
            const newTrade = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('fr-FR'),
                type: tradeType,
                amount: tradeAmount.toFixed(2),
                price: state.currentPrice.toFixed(2),
                profit: netProfit.toFixed(2),
                profitPct: tradeType === 'SELL' ? ((netProfit / state.positionAmount) * 100).toFixed(2) : '0',
                fees: actualFees.toFixed(6),
                reason: reason,
                score: score,
                mode: 'real'
            };
            
            state.trades.unshift(newTrade);
            state.trades = state.trades.slice(0, 20);
            
            state.isTrading = false;
            
            renderTrades();
            updateUI();
        }

        function renderTrades() {
            if (state.trades.length === 0) return;
            document.getElementById('tradesContainer').innerHTML = state.trades.map(t => `
                <div class="flex justify-between p-3 glass-effect rounded-lg mb-2 border-l-4 ${t.type === 'BUY' ? 'border-green-500' : 'border-red-500'}">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="${t.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-xl">${t.type === 'BUY' ? 'üü¢' : 'üî¥'}</span>
                            <span class="font-bold">${t.type}</span>
                            <span class="text-xs bg-purple-400/20 px-2 py-1 rounded">${t.reason}</span>
                            <span class="text-xs bg-orange-400/20 text-orange-400 px-2 py-1 rounded font-bold">ü§ñ JERCAT AUTO</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${t.time}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-mono">$${t.price}</p>
                        ${t.type === 'SELL' ? `
                            <p class="text-lg font-bold ${parseFloat(t.profitPct) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${parseFloat(t.profitPct) >= 0 ? '+' : ''}${t.profitPct}%
                            </p>
                            <p class="text-xs ${parseFloat(t.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(t.profit) >= 0 ? '+' : ''}${t.profit} USDT</p>
                        ` : '<p class="text-sm text-gray-400">Ouvert</p>'}
                    </div>
                </div>
            `).join('');
        }

        async function updateBalance() {
            if (!state.isConnected || !state.wallet) {
                return;
            }
            
            try {
                const usdtContract = new ethers.Contract(USDT, USDT_ABI, state.provider);
                const usdtBalance = await usdtContract.balanceOf(state.account);
                const usdtBalanceFormatted = parseFloat(ethers.utils.formatUnits(usdtBalance, 18));
                
                debugLog(`üí∞ Balance USDT: ${usdtBalanceFormatted.toFixed(2)} USDT`, 'info');
                state.usdtBalance = usdtBalanceFormatted;
                
            } catch (error) {
                debugLog(`‚ùå Erreur balance: ${error.message}`, 'error');
            }
        }

        function updateUI() {
            if (state.isConnected) {
                if (state.connectionMethod === 'jercat-wallet') {
                    document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all shadow-lg';
                    document.getElementById('connectBtn').style.background = 'linear-gradient(135deg, #f59e0b 0%, #f97316 100%)';
                    document.getElementById('connectBtn').style.color = '#000';
                    document.getElementById('walletText').textContent = `JERCAT: ${state.account.slice(0, 6)}...`;
                    
                    if (state.jercatTrusted) {
                        document.getElementById('walletStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                    } else {
                        document.getElementById('walletStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Wallet</span>';
                    }
                } else if (state.connectionMethod === 'privatekey') {
                    document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-blue-600 hover:bg-blue-700 shadow-lg';
                    document.getElementById('walletText').textContent = `${state.account.slice(0, 6)}...`;
                    document.getElementById('walletStatus').innerHTML = '<span style="color: #3b82f6;">üü¢ Cl√© Priv√©e</span>';
                } else {
                    document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-green-600 hover:bg-green-700 shadow-lg';
                    document.getElementById('walletText').textContent = `${state.account.slice(0, 6)}...`;
                    document.getElementById('walletStatus').innerHTML = '<span style="color: #10b981;">üü¢ MetaMask</span>';
                }
            }
            
            if (state.botRunning) {
                document.getElementById('botIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('botText').textContent = 'Stop';
                document.getElementById('toggleBotBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-red-600 hover:bg-red-700';
            } else {
                document.getElementById('botIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('botText').textContent = 'Start';
                if (state.capitalSet) {
                    document.getElementById('toggleBotBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-green-600 hover:bg-green-700';
                }
            }
            
            document.getElementById('modeStatus').innerHTML = '<span style="color: #f59e0b;">ü§ñ JERCAT AUTO (USDT)</span>';
            document.getElementById('profitDisplay').textContent = state.portfolio.profit.toFixed(2);
            document.getElementById('tradesCount').textContent = state.trades.length;
            
            if (state.currentPosition) {
                const profitPct = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                document.getElementById('positionStatus').innerHTML = `<span class="${profitPct >= 0 ? 'text-green-400' : 'text-red-400'}">üü¢ ${profitPct >= 0 ? '+' : ''}${profitPct.toFixed(2)}%</span>`;
            } else {
                document.getElementById('positionStatus').textContent = '‚ö™ None';
            }
            
            const totalTrades = state.portfolio.wins + state.portfolio.losses;
            const winRate = totalTrades > 0 ? ((state.portfolio.wins / totalTrades) * 100).toFixed(0) : 0;
            document.getElementById('winRateDisplay').textContent = winRate + '%';
        }
    </script>
</body>
</html>') || 
                document.referrer.includes('jercat-wallet') ||
                document.referrer.includes('localhost')) {
                state.jercatTrusted = true;
                debugLog('ü§ñ JERCAT Wallet d√©tect√© via referrer', 'success');
                debugLog('‚úÖ Mode AUTO-VALIDATION activ√©', 'success');
                document.getElementById('jercatStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
            }
            
            if (window.opener) {
                state.jercatTrusted = true;
                debugLog('ü§ñ Ouvert par JERCAT Wallet', 'success');
                debugLog('‚úÖ Mode AUTO-VALIDATION activ√©', 'success');
                document.getElementById('jercatStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
            }
            
            initChart();
            loadCryptos();
        });

        window.addEventListener('message', async (event) => {
            if (!event.origin.includes('wallet-one-ochre.vercel.app') && 
                !event.origin.includes('localhost') &&
                !event.origin.includes('jercat-wallet')) {
                return;
            }

            const data = event.data;
            
            if (data.type === 'JERCAT_WALLET_CONNECTED') {
                debugLog('üì® Message re√ßu du JERCAT Wallet', 'success');
                debugLog(`üìç Adresse: ${data.account.slice(0, 10)}...`, 'info');
                
                state.jercatTrusted = true;
                document.getElementById('jercatStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                
                if (data.privateKey) {
                    try {
                        debugLog('üîë Cl√© priv√©e re√ßue - Connexion automatique...', 'info');
                        
                        state.provider = new ethers.providers.JsonRpcProvider(BSC_RPCS[0]);
                        
                        const key = data.privateKey.startsWith('0x') ? data.privateKey : '0x' + data.privateKey;
                        state.wallet = new ethers.Wallet(key, state.provider);
                        state.account = state.wallet.address;
                        state.isConnected = true;
                        state.connectionMethod = 'jercat-wallet';
                        
                        debugLog(`‚úÖ Connect√© automatiquement: ${state.account.slice(0, 10)}...`, 'success');
                        debugLog('ü§ñ Mode AUTO-TRADING R√âEL activ√© !', 'success');
                        debugLog('üî• Zero-Click Trading : Trades ex√©cut√©s automatiquement', 'success');
                        
                        updateUI();
                        await updateBalance();
                        
                        document.getElementById('cryptoSelector').classList.remove('hidden');
                        document.getElementById('capitalSection').classList.remove('hidden');
                        document.getElementById('statsCards').classList.remove('hidden');
                        
                        alert('‚úÖ Connexion JERCAT Wallet r√©ussie !\n\nü§ñ Auto-Trading R√âEL activ√©\nüìç ' + state.account.slice(0, 20) + '...\n\nüî• Trades sans confirmation');
                        
                    } catch (error) {
                        debugLog(`‚ùå Erreur connexion auto: ${error.message}`, 'error');
                    }
                    
                } else {
                    state.account = data.account;
                    state.isConnected = false;
                    debugLog('üëÅÔ∏è Mode lecture seule (adresse uniquement)', 'info');
                    updateUI();
                }
            }
        });

        function initChart() {
            const ctx = document.getElementById('tradingChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#f59e0b',
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: true, grid: { color: 'rgba(245, 158, 11, 0.1)' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask non install√©');
                return;
            }
            try {
                debugLog('üîÑ Connexion MetaMask...', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.wallet = state.provider.getSigner();
                state.isConnected = true;
                state.connectionMethod = 'metamask';
                
                debugLog(`‚úÖ Connect√©: ${state.account.slice(0, 6)}...`, 'success');
                
                document.getElementById('cryptoSelector').classList.remove('hidden');
                document.getElementById('capitalSection').classList.remove('hidden');
                updateUI();
                
                await updateBalance();
            } catch (error) {
                debugLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function connectWithPrivateKey() {
            const pk = document.getElementById('privateKeyInput').value.trim();
            if (!pk) {
                alert('‚ùå Entrez votre cl√© priv√©e');
                return;
            }
            try {
                debugLog('üîÑ Connexion avec cl√© priv√©e...', 'info');
                
                state.provider = new ethers.providers.JsonRpcProvider(BSC_RPCS[0]);
                
                const key = pk.startsWith('0x') ? pk : '0x' + pk;
                state.wallet = new ethers.Wallet(key, state.provider);
                state.account = state.wallet.address;
                state.isConnected = true;
                state.connectionMethod = 'privatekey';
                
                debugLog(`‚úÖ Connect√©: ${state.account.slice(0, 6)}...`, 'success');
                
                togglePrivateKeyModal();
                document.getElementById('privateKeyInput').value = '';
                
                document.getElementById('cryptoSelector').classList.remove('hidden');
                document.getElementById('capitalSection').classList.remove('hidden');
                updateUI();
                
                await updateBalance();
            } catch (error) {
                debugLog(`‚ùå Erreur: ${error.message}`, 'error');
                alert(`‚ùå Cl√© priv√©e invalide`);
            }
        }

        function loadCryptos() {
            const cryptos = [
                { symbol: 'BTCUSDT', name: 'BTC' },
                { symbol: 'ETHUSDT', name: 'ETH' },
                { symbol: 'BNBUSDT', name: 'BNB' }
            ];
            document.getElementById('cryptoSelect').innerHTML = cryptos.map(c => 
                `<option value="${c.symbol}">${c.name}</option>`
            ).join('');
            state.selectedCrypto = cryptos[0].symbol;
            connectWebSocket();
        }

        function changeCrypto() {
            state.selectedCrypto = document.getElementById('cryptoSelect').value;
            debugLog(`üîÑ Crypto: ${state.selectedCrypto}`, 'info');
            connectWebSocket();
        }

        function changeTradingMode() {
            state.tradingMode = 'real';
            debugLog('üîí Mode R√âEL fixe activ√©', 'warning');
        }

        function connectWebSocket() {
            if (ws) ws.close();
            const symbol = state.selectedCrypto.toLowerCase();
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@ticker`);
            
            ws.onopen = () => debugLog(`üü¢ WebSocket: ${state.selectedCrypto}`, 'success');
            
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                state.currentPrice = parseFloat(data.c);
                const volume = parseFloat(data.v);
                
                state.priceHistory.push(state.currentPrice);
                state.volumeHistory.push(volume);
                
                if (state.priceHistory.length > 200) state.priceHistory.shift();
                if (state.volumeHistory.length > 50) state.volumeHistory.shift();
                
                if (state.priceHistory.length >= 50) updateIndicators();
                if (state.priceHistory.length % 5 === 0) updateChart();
                
                document.getElementById('currentPrice').textContent = state.currentPrice.toFixed(2);
            };
        }

        function calculateEMA(prices, period) {
            if (prices.length === 0) return 0;
            const k = 2 / (period + 1);
            let ema = prices[0];
            for (let i = 1; i < prices.length; i++) {
                ema = (prices[i] - ema) * k + ema;
            }
            return ema;
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + avgGain / avgLoss));
        }

        function calculateMACD(prices) {
            if (prices.length < 26) return { macd: 0, hist: 0 };
            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);
            const macd = ema12 - ema26;
            const macdLine = [];
            for (let i = 26; i <= prices.length; i++) {
                const slice = prices.slice(0, i);
                const e12 = calculateEMA(slice, 12);
                const e26 = calculateEMA(slice, 26);
                macdLine.push(e12 - e26);
            }
            const signal = calculateEMA(macdLine, 9);
            return { macd, hist: macd - signal };
        }

        function calculateBB(prices, period = 20, stdDev = 2) {
            if (prices.length < period) return { upper: 0, lower: 0 };
            const slice = prices.slice(-period);
            const avg = slice.reduce((a, b) => a + b, 0) / period;
            const variance = slice.reduce((sum, p) => sum + Math.pow(p - avg, 2), 0) / period;
            const std = Math.sqrt(variance);
            return {
                upper: avg + (std * stdDev),
                lower: avg - (std * stdDev)
            };
        }

        function calculateATR(prices, period = 14) {
            if (prices.length < period + 1) return 0;
            let sum = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const high = prices[i] * 1.01;
                const low = prices[i] * 0.99;
                const prev = i > 0 ? prices[i - 1] : prices[i];
                sum += Math.max(high - low, Math.abs(high - prev), Math.abs(low - prev));
            }
            return sum / period;
        }

        function updateIndicators() {
            if (state.priceHistory.length < 50) return;
            
            state.indicators.ema9 = calculateEMA(state.priceHistory, 9);
            state.indicators.ema21 = calculateEMA(state.priceHistory, 21);
            state.indicators.ema50 = calculateEMA(state.priceHistory, 50);
            state.indicators.rsi = calculateRSI(state.priceHistory, 14);
            
            const macd = calculateMACD(state.priceHistory);
            state.lastMacdHist = state.indicators.macdHist || 0;
            state.indicators.macd = macd.macd;
            state.indicators.macdHist = macd.hist;
            
            const bb = calculateBB(state.priceHistory, 20, 2);
            state.indicators.bbUpper = bb.upper;
            state.indicators.bbLower = bb.lower;
            state.indicators.atr = calculateATR(state.priceHistory, 14);
            
            if (state.volumeHistory.length >= 20) {
                state.indicators.volumeAvg = state.volumeHistory.slice(-20).reduce((a, b) => a + b, 0) / 20;
            }
            state.indicators.volume = state.volumeHistory[state.volumeHistory.length - 1] || 0;
            
            updateSignals();
        }

        function updateSignals() {
            const { ema9, ema21, ema50, rsi, macdHist, bbUpper, bbLower, volume, volumeAvg, atr } = state.indicators;
            
            state.signals.trend = ema9 > ema21 && ema21 > ema50;
            state.signals.rsi = rsi >= 25 && rsi <= 45;
            state.signals.macd = macdHist > 0 && state.lastMacdHist <= 0;
            
            const distBB = ((state.currentPrice - bbLower) / bbLower) * 100;
            state.signals.bollinger = distBB >= -0.5 && distBB <= 2;
            
            state.signals.volume = volume > volumeAvg * 1.5;
            
            const atrPct = (atr / state.currentPrice) * 100;
            state.signals.volatility = atrPct > 1 && atrPct < 4;
            
            updateSignalUI('trend', state.signals.trend, `${ema9.toFixed(2)}`);
            updateSignalUI('rsi', state.signals.rsi, `${rsi.toFixed(1)}`);
            updateSignalUI('macd', state.signals.macd, `${macdHist.toFixed(4)}`);
            updateSignalUI('bollinger', state.signals.bollinger, `${distBB.toFixed(2)}%`);
            updateSignalUI('volume', state.signals.volume, `${volumeAvg > 0 ? (volume / volumeAvg * 100).toFixed(0) : 100}%`);
            updateSignalUI('volatility', state.signals.volatility, `${atrPct.toFixed(2)}%`);
            
            const signals = Object.values(state.signals);
            const score = Math.round((signals.filter(s => s).length / signals.length) * 100);
            const minScore = parseInt(document.getElementById('minScore').value);
            
            document.getElementById('signal-score').textContent = score + '%';
            document.getElementById('signal-progress').style.width = score + '%';
            document.getElementById('signal-status').textContent = score >= minScore ? '‚úÖ Signal BUY!' : `‚è≥ ${score}%`;
        }

        function updateSignalUI(name, isValid, value) {
            const icon = document.getElementById(`signal-${name}-icon`);
            const display = document.getElementById(`${name}-display`);
            const container = document.getElementById(`signal-${name}`);
            if (icon) icon.textContent = isValid ? '‚úÖ' : '‚ö™';
            if (display) display.textContent = value;
            if (container) {
                container.className = isValid ? 'bg-green-500/30 border-2 border-green-500 rounded-lg p-3' : 'glass-effect border-2 border-slate-600 rounded-lg p-3';
            }
        }

        function updateChart() {
            if (!chart || state.priceHistory.length === 0) return;
            const maxPoints = 50;
            const prices = state.priceHistory.slice(-maxPoints);
            const labels = prices.map((_, i) => {
                const date = new Date(Date.now() - (maxPoints - i) * 10000);
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            });
            chart.data.labels = labels;
            chart.data.datasets[0].data = prices;
            chart.update('none');
        }

        function setCapital() {
            const cap = parseFloat(document.getElementById('capitalInput').value);
            if (!cap || cap <= 0) {
                alert('‚ùå Montant invalide');
                return;
            }
            state.tradingCapital = cap;
            state.initialCapital = cap;
            state.capitalSet = true;
            debugLog(`‚úÖ Capital: ${cap} USDT`, 'success');
            
            document.getElementById('capitalSection').classList.add('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('capitalDisplay').textContent = cap.toFixed(2);
            document.getElementById('toggleBotBtn').disabled = false;
            document.getElementById('toggleBotBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-green-600 hover:bg-green-700';
            
            updateUI();
        }

        function toggleBot() {
            state.botRunning = !state.botRunning;
            if (state.botRunning) {
                startBot();
            } else {
                stopBot();
            }
            updateUI();
        }

        function startBot() {
            if (!verifyRealMode()) {
                return;
            }
            
            debugLog('üöÄ BOT D√âMARR√â - MODE R√âEL', 'success');
            debugLog(`üí∞ Capital: ${state.tradingCapital} USDT`, 'info');
            debugLog(`‚ö†Ô∏è TRANSACTIONS BLOCKCHAIN R√âELLES!`, 'warning');
            if (state.jercatTrusted) {
                debugLog('ü§ñ Mode AUTO-VALIDATION: Trades sans confirmation', 'success');
            }
            
            botInterval = setInterval(() => {
                if (state.priceHistory.length < 50) {
                    debugLog(`‚è≥ Collecte donn√©es: ${state.priceHistory.length}/50`, 'warning');
                    return;
                }
                
                updateIndicators();
                const signal = getTradeSignal();
                
                if (signal.signal && !state.isTrading) {
                    executeTrade(signal.signal, signal.score, signal.reason);
                }
            }, 3000);
        }

        function stopBot() {
            if (botInterval) {
                clearInterval(botInterval);
                botInterval = null;
                debugLog('üõë BOT ARR√äT√â', 'warning');
                const ret = ((state.tradingCapital - state.initialCapital) / state.initialCapital * 100);
                debugLog(`üìä Performance: ${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%`, ret >= 0 ? 'success' : 'error');
            }
        }

        function getTradeSignal() {
            const minScore = parseInt(document.getElementById('minScore').value);
            
            if (!state.currentPosition) {
                const signals = Object.values(state.signals);
                const score = Math.round((signals.filter(s => s).length / signals.length) * 100);
                if (score >= minScore) {
                    const reasons = [];
                    if (state.signals.trend) reasons.push('EMA‚Üë');
                    if (state.signals.rsi) reasons.push(`RSI:${state.indicators.rsi.toFixed(0)}`);
                    if (state.signals.macd) reasons.push('MACD‚úì');
                    return { signal: 'BUY', score, reason: reasons.join('|') };
                }
                return { signal: null, score: 0 };
            } else {
                const profitPct = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                const atrPct = (state.indicators.atr / state.lastBuyPrice) * 100;
                const tpMult = parseFloat(document.getElementById('tpMultiplier').value);
                const slMult = parseFloat(document.getElementById('slMultiplier').value);
                
                const dynamicTP = atrPct * tpMult;
                const dynamicSL = -atrPct * slMult;
                
                if (profitPct >= state.minProfitPct) {
                    debugLog(`üíé Profit atteint: ${profitPct.toFixed(2)}% (min: ${state.minProfitPct}%)`, 'success');
                    return { signal: 'SELL', score: 100, reason: `Profit +${profitPct.toFixed(2)}%` };
                }
                
                if (profitPct <= dynamicSL) {
                    return { signal: 'SELL', score: 100, reason: `SL ${dynamicSL.toFixed(2)}%` };
                }
                
                if (profitPct >= dynamicTP) {
                    return { signal: 'SELL', score: 100, reason: `TP +${dynamicTP.toFixed(2)}%` };
                }
                
                if (state.indicators.rsi > 75 && profitPct > 0.5) {
                    return { signal: 'SELL', score: 100, reason: `RSI:${state.indicators.rsi.toFixed(0)}` };
                }
                
                return { signal: null, score: 0 };
            }
        }

        async function executeTrade(tradeType, score, reason) {
            state.isTrading = true;
            
            debugLog(`${tradeType === 'BUY' ? 'üü¢' : 'üî¥'} ${tradeType} - ${reason}`, tradeType === 'BUY' ? 'success' : 'warning');
            
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const tradeAmount = (state.tradingCapital * percent) / 100;
            
            let netProfit = 0;
            let actualFees = 0;
            
            if (!state.isConnected || !state.wallet) {
                debugLog(`‚ùå ERREUR: Wallet non connect√©!`, 'error');
                alert('‚ö†Ô∏è Connectez votre wallet pour trader en MODE R√âEL');
                state.isTrading = false;
                return;
            }
            
            try {
                const network = await state.provider.getNetwork();
                if (network.chainId !== 56) {
                    debugLog(`‚ùå ERREUR: Mauvais network! ChainID: ${network.chainId}`, 'error');
                    alert(`‚ö†Ô∏è Changez vers BSC Mainnet!\n\nNetwork actuel: ${network.name} (${network.chainId})\nRequis: BSC Mainnet (56)`);
                    state.isTrading = false;
                    return;
                }
                
                // üíµ V√âRIFIER LA BALANCE USDT
                const usdtContract = new ethers.Contract(USDT, USDT_ABI, state.provider);
                const usdtBalance = await usdtContract.balanceOf(state.account);
                const usdtBalanceFormatted = parseFloat(ethers.utils.formatUnits(usdtBalance, 18));
                
                debugLog(`üí∞ Balance USDT: ${usdtBalanceFormatted.toFixed(2)} USDT`, 'info');
                state.usdtBalance = usdtBalanceFormatted;
                
                if (tradeType === 'BUY') {
                    if (usdtBalanceFormatted < tradeAmount) {
                        debugLog(`‚ùå Balance USDT insuffisante!`, 'error');
                        debugLog(`üí∞ Requis: ${tradeAmount.toFixed(2)} USDT`, 'error');
                        debugLog(`üí∞ Disponible: ${usdtBalanceFormatted.toFixed(2)} USDT`, 'error');
                        alert(`‚ùå Balance USDT insuffisante!\n\nTrade: ${tradeAmount.toFixed(2)} USDT\nDisponible: ${usdtBalanceFormatted.toFixed(2)} USDT\n\nüí° R√©duisez votre capital ou le % par trade!`);
                        state.isTrading = false;
                        return;
                    }
                }
                
                debugLog('üîó Ex√©cution BLOCKCHAIN sur BSC...', 'warning');
                debugLog(`üí∞ Montant du trade: ${tradeAmount.toFixed(2)} USDT`, 'info');
                
                const tokenAddress = getTokenAddress(state.selectedCrypto);
                const amountInWei = ethers.utils.parseUnits(tradeAmount.toFixed(6), 18);
                
                const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
                
                if (tradeType === 'BUY') {
                    debugLog('üí∞ Achat via PancakeSwap (USDT ‚Üí Token)...', 'info');
                    debugLog(`üéØ Token: ${tokenAddress}`, 'info');
                    
                    // 1Ô∏è‚É£ Approuver USDT pour le router
                    debugLog('üìù Approbation USDT...', 'info');
                    const usdtContractSigner = new ethers.Contract(USDT, USDT_ABI, state.wallet);
                    const approveTx = await usdtContractSigner.approve(PANCAKE_ROUTER, amountInWei);
                    debugLog(`‚è≥ Approbation: ${approveTx.hash.slice(0, 10)}...`, 'info');
                    await approveTx.wait();
                    debugLog(`‚úÖ USDT approuv√©`, 'success');
                    
                    // 2Ô∏è‚É£ Swap USDT ‚Üí Token
                    const routerABI = [
                        'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
                    ];
                    
                    const router = new ethers.Contract(PANCAKE_ROUTER, routerABI, state.wallet);
                    
                    const path = [USDT, tokenAddress];
                    const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                    const amountOutMin = 0;
                    
                    debugLog('üìù Pr√©paration du swap USDT ‚Üí Token...', 'info');
                    
                    let gasLimit;
                    try {
                        const estimatedGas = await router.estimateGas.swapExactTokensForTokens(
                            amountInWei,
                            amountOutMin,
                            path,
                            state.account,
                            deadline
                        );
                        gasLimit = estimatedGas.mul(120).div(100);
                        debugLog(`‚õΩ Gas estim√©: ${estimatedGas.toString()}`, 'info');
                    } catch (error) {
                        debugLog(`‚ö†Ô∏è Impossible d'estimer le gas, utilisation de 300000`, 'warning');
                        gasLimit = ethers.BigNumber.from('300000');
                    }
                    
                    const tx = await router.swapExactTokensForTokens(
                        amountInWei,
                        amountOutMin,
                        path,
                        state.account,
                        deadline,
                        { gasLimit: gasLimit }
                    );
                    
                    debugLog(`‚è≥ Transaction envoy√©e: ${tx.hash.slice(0, 10)}...`, 'info');
                    debugLog(`üîó BscScan: https://bscscan.com/tx/${tx.hash}`, 'success');
                    
                    const receipt = await tx.wait();
                    debugLog(`‚úÖ Transaction confirm√©e! Bloc: ${receipt.blockNumber}`, 'success');
                    
                    actualFees = parseFloat(ethers.utils.formatEther(receipt.gasUsed.mul(receipt.effectiveGasPrice)));
                    debugLog(`‚õΩ Frais gas: ${actualFees.toFixed(6)} BNB`, 'info');
                    
                } else {
                    debugLog('üí∏ Vente via PancakeSwap (Token ‚Üí USDT)...', 'info');
                    
                    const routerABI = [
                        'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
                    ];
                    
                    const tokenABI = [
                        'function approve(address spender, uint256 amount) external returns (bool)',
                        'function balanceOf(address account) view returns (uint256)'
                    ];
                    
                    const tokenContract = new ethers.Contract(tokenAddress, tokenABI, state.wallet);
                    const tokenBalance = await tokenContract.balanceOf(state.account);
                    
                    debugLog(`üìä Balance token: ${ethers.utils.formatEther(tokenBalance)}`, 'info');
                    
                    if (tokenBalance.isZero()) {
                        debugLog(`‚ùå Aucun token √† vendre!`, 'error');
                        alert('‚ùå Aucun token dans votre wallet!');
                        state.isTrading = false;
                        return;
                    }
                    
                    debugLog('üìù Approbation du router...', 'info');
                    const approveTx = await tokenContract.approve(PANCAKE_ROUTER, tokenBalance);
                    debugLog(`‚è≥ Approbation: ${approveTx.hash.slice(0, 10)}...`, 'info');
                    await approveTx.wait();
                    debugLog(`‚úÖ Approbation confirm√©e`, 'success');
                    
                    const router = new ethers.Contract(PANCAKE_ROUTER, routerABI, state.wallet);
                    const path = [tokenAddress, USDT];
                    const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                    const amountOutMin = 0;
                    
                    debugLog('üìù Pr√©paration de la vente (Token ‚Üí USDT)...', 'info');
                    
                    let gasLimit;
                    try {
                        const estimatedGas = await router.estimateGas.swapExactTokensForTokens(
                            tokenBalance,
                            amountOutMin,
                            path,
                            state.account,
                            deadline
                        );
                        gasLimit = estimatedGas.mul(120).div(100);
                        debugLog(`‚õΩ Gas estim√©: ${estimatedGas.toString()}`, 'info');
                    } catch (error) {
                        debugLog(`‚ö†Ô∏è Impossible d'estimer le gas, utilisation de 300000`, 'warning');
                        gasLimit = ethers.BigNumber.from('300000');
                    }
                    
                    const tx = await router.swapExactTokensForTokens(
                        tokenBalance,
                        amountOutMin,
                        path,
                        state.account,
                        deadline,
                        { gasLimit: gasLimit }
                    );
                    
                    debugLog(`‚è≥ Transaction envoy√©e: ${tx.hash.slice(0, 10)}...`, 'info');
                    debugLog(`üîó BscScan: https://bscscan.com/tx/${tx.hash}`, 'success');
                    
                    const receipt = await tx.wait();
                    debugLog(`‚úÖ Transaction confirm√©e! Bloc: ${receipt.blockNumber}`, 'success');
                    
                    actualFees = parseFloat(ethers.utils.formatEther(receipt.gasUsed.mul(receipt.effectiveGasPrice)));
                    debugLog(`‚õΩ Frais gas: ${actualFees.toFixed(6)} BNB`, 'info');
                }
                
            } catch (error) {
                debugLog(`‚ùå ERREUR BLOCKCHAIN: ${error.message}`, 'error');
                
                if (error.message.includes('insufficient funds')) {
                    alert('‚ùå Fonds insuffisants!\n\nV√©rifiez votre balance USDT.\n\nüí° R√©duisez votre capital ou le % par trade!');
                } else if (error.message.includes('user rejected')) {
                    alert('‚ùå Transaction rejet√©e par l\'utilisateur');
                } else if (error.message.includes('INSUFFICIENT_OUTPUT_AMOUNT')) {
                    alert('‚ùå Slippage trop √©lev√©!\n\nLe prix a trop boug√©. R√©essayez.');
                } else {
                    alert(`‚ùå Erreur: ${error.message.slice(0, 100)}`);
                }
                
                state.isTrading = false;
                return;
            }
            
            if (tradeType === 'BUY') {
                if (tradeAmount > state.tradingCapital) {
                    debugLog(`‚ùå Capital insuffisant`, 'error');
                    state.isTrading = false;
                    return;
                }
                
                state.tradingCapital -= tradeAmount;
                state.currentPosition = 'BUY';
                state.lastBuyPrice = state.currentPrice;
                state.positionAmount = tradeAmount;
                state.entryFees = actualFees;
                
                debugLog(`üìà POSITION OUVERTE`, 'success');
                debugLog(`üíµ Montant: ${state.positionAmount.toFixed(2)} USDT`, 'info');
                
            } else {
                const profitPct = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                const grossProfit = state.positionAmount * (profitPct / 100);
                netProfit = grossProfit;
                
                state.tradingCapital += state.positionAmount + grossProfit;
                
                debugLog(`üìâ POSITION FERM√âE`, netProfit >= 0 ? 'success' : 'error');
                debugLog(`üíé NET: ${netProfit >= 0 ? '+' : ''}${netProfit.toFixed(2)} USDT`, netProfit >= 0 ? 'success' : 'error');
                
                state.currentPosition = null;
                state.entryFees = 0;
                
                if (netProfit > 0) state.portfolio.wins++;
                else state.portfolio.losses++;
                state.portfolio.profit += netProfit;
            }
            
            const newTrade = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('fr-FR'),
                type: tradeType,
                amount: tradeAmount.toFixed(2),
                price: state.currentPrice.toFixed(2),
                profit: netProfit.toFixed(2),
                profitPct: tradeType === 'SELL' ? ((netProfit / state.positionAmount) * 100).toFixed(2) : '0',
                fees: actualFees.toFixed(6),
                reason: reason,
                score: score,
                mode: 'real'
            };
            
            state.trades.unshift(newTrade);
            state.trades = state.trades.slice(0, 20);
            
            state.isTrading = false;
            
            renderTrades();
            updateUI();
        }

        function renderTrades() {
            if (state.trades.length === 0) return;
            document.getElementById('tradesContainer').innerHTML = state.trades.map(t => `
                <div class="flex justify-between p-3 glass-effect rounded-lg mb-2 border-l-4 ${t.type === 'BUY' ? 'border-green-500' : 'border-red-500'}">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="${t.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-xl">${t.type === 'BUY' ? 'üü¢' : 'üî¥'}</span>
                            <span class="font-bold">${t.type}</span>
                            <span class="text-xs bg-purple-400/20 px-2 py-1 rounded">${t.reason}</span>
                            <span class="text-xs bg-orange-400/20 text-orange-400 px-2 py-1 rounded font-bold">ü§ñ JERCAT AUTO</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${t.time}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-mono">$${t.price}</p>
                        ${t.type === 'SELL' ? `
                            <p class="text-lg font-bold ${parseFloat(t.profitPct) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${parseFloat(t.profitPct) >= 0 ? '+' : ''}${t.profitPct}%
                            </p>
                            <p class="text-xs ${parseFloat(t.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(t.profit) >= 0 ? '+' : ''}${t.profit} USDT</p>
                        ` : '<p class="text-sm text-gray-400">Ouvert</p>'}
                    </div>
                </div>
            `).join('');
        }

        async function updateBalance() {
            if (!state.isConnected || !state.wallet) {
                return;
            }
            
            try {
                const usdtContract = new ethers.Contract(USDT, USDT_ABI, state.provider);
                const usdtBalance = await usdtContract.balanceOf(state.account);
                const usdtBalanceFormatted = parseFloat(ethers.utils.formatUnits(usdtBalance, 18));
                
                debugLog(`üí∞ Balance USDT: ${usdtBalanceFormatted.toFixed(2)} USDT`, 'info');
                state.usdtBalance = usdtBalanceFormatted;
                
            } catch (error) {
                debugLog(`‚ùå Erreur balance: ${error.message}`, 'error');
            }
        }

        function updateUI() {
            if (state.isConnected) {
                if (state.connectionMethod === 'jercat-wallet') {
                    document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all shadow-lg';
                    document.getElementById('connectBtn').style.background = 'linear-gradient(135deg, #f59e0b 0%, #f97316 100%)';
                    document.getElementById('connectBtn').style.color = '#000';
                    document.getElementById('walletText').textContent = `JERCAT: ${state.account.slice(0, 6)}...`;
                    
                    if (state.jercatTrusted) {
                        document.getElementById('walletStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Auto ‚úÖ</span>';
                    } else {
                        document.getElementById('walletStatus').innerHTML = '<span style="color: #10b981;">üü¢ JERCAT Wallet</span>';
                    }
                } else if (state.connectionMethod === 'privatekey') {
                    document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-blue-600 hover:bg-blue-700 shadow-lg';
                    document.getElementById('walletText').textContent = `${state.account.slice(0, 6)}...`;
                    document.getElementById('walletStatus').innerHTML = '<span style="color: #3b82f6;">üü¢ Cl√© Priv√©e</span>';
                } else {
                    document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all bg-green-600 hover:bg-green-700 shadow-lg';
                    document.getElementById('walletText').textContent = `${state.account.slice(0, 6)}...`;
                    document.getElementById('walletStatus').innerHTML = '<span style="color: #10b981;">üü¢ MetaMask</span>';
                }
            }
            
            if (state.botRunning) {
                document.getElementById('botIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('botText').textContent = 'Stop';
                document.getElementById('toggleBotBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-red-600 hover:bg-red-700';
            } else {
                document.getElementById('botIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('botText').textContent = 'Start';
                if (state.capitalSet) {
                    document.getElementById('toggleBotBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-green-600 hover:bg-green-700';
                }
            }
            
            document.getElementById('modeStatus').innerHTML = '<span style="color: #f59e0b;">ü§ñ JERCAT AUTO (USDT)</span>';
            document.getElementById('profitDisplay').textContent = state.portfolio.profit.toFixed(2);
            document.getElementById('tradesCount').textContent = state.trades.length;
            
            if (state.currentPosition) {
                const profitPct = ((state.currentPrice - state.lastBuyPrice) / state.lastBuyPrice) * 100;
                document.getElementById('positionStatus').innerHTML = `<span class="${profitPct >= 0 ? 'text-green-400' : 'text-red-400'}">üü¢ ${profitPct >= 0 ? '+' : ''}${profitPct.toFixed(2)}%</span>`;
            } else {
                document.getElementById('positionStatus').textContent = '‚ö™ None';
            }
            
            const totalTrades = state.portfolio.wins + state.portfolio.losses;
            const winRate = totalTrades > 0 ? ((state.portfolio.wins / totalTrades) * 100).toFixed(0) : 0;
            document.getElementById('winRateDisplay').textContent = winRate + '%';
        }
    </script>
</body>
</html>
